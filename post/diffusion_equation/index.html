<!doctype html>
<html class="no-js" lang="en-us">
  <head>
    <meta charset="utf-8">
    <title>Exploring the diffusion equation with Python | Zoltán Sylvester</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://zsylvester.github.io/css/foundation.min.css">
    <link rel="stylesheet" href="https://zsylvester.github.io/css/highlight.min.css">
    <link rel="stylesheet" href="https://zsylvester.github.io/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://zsylvester.github.io/css/academicons.min.css">
    <link rel="stylesheet" href="https://zsylvester.github.io/css/fonts.css">
    <link rel="stylesheet" href="https://zsylvester.github.io/css/finite.css">
  </head>
  <body>
    <header>
      <nav class="nav-bar">
	
	  <div class="title-bar" data-responsive-toggle="site-menu" data-hide-for="medium">	      
	    <button class="site-hamburger" type="button" data-toggle>
	      <i class="fa fa-bars fa-lg" aria-hidden="true"></i>
	    </button>
	    <div class="title-bar-title site-title">
	      <a href="https://zsylvester.github.io/">Zoltán Sylvester</a>
	    </div>
	    <div class="title-bar-right pull-right">
	      



	    </div>
	  </div>
	    
	  
	    <div class="top-bar" id="site-menu" >     
	      <div class="top-bar-title show-for-medium site-title">
		      <a href="https://zsylvester.github.io/">Zoltán Sylvester</a>
	      </div>
	      <div class="top-bar-left">
		      <ul class="menu vertical medium-horizontal">
  		      
  		      
  		      <li><a href="https://zsylvester.github.io/research/">Research</a></li>
  		      
  		      <li><a href="https://zsylvester.github.io/publication/">Publications</a></li>
  		      
  		      <li><a href="https://zsylvester.github.io/post/">Blog</a></li>
  		      
		      </ul>
	      </div>
	      <div class="top-bar-right show-for-medium">
      		



	      </div>
	    </div>
	  
	</nav>
    </header>
    <main>
      
<div class="row">
  <div class="column small-12 medium-10 medium-offset-1 end large-8 large-offset-0">
    <article class="article" itemscope itemtype="http://schema.org/Article">
      
      <h1 itemprop="name">Exploring the diffusion equation with Python</h1>
      <div class="post-metadata">
  <span class="post-date">
    <time datetime="2015-02-06 00:00:00 &#43;0000 UTC" itemprop="datePublished">February 6, 2015</time>
  </span>
  
  
  
  <span class="post-tags">
    <span class="nowrap"><i class="fa fa-tags"></i>
    
    <a class="post-tag" href="https://zsylvester.github.io/tags/geology">geology</a>,</span> 
    
    <a class="post-tag" href="https://zsylvester.github.io/tags/modeling">modeling</a>, 
    
    <a class="post-tag" href="https://zsylvester.github.io/tags/python">python</a>, 
    
    <a class="post-tag" href="https://zsylvester.github.io/tags/sedimentology">sedimentology</a>, 
    
    <a class="post-tag" href="https://zsylvester.github.io/tags/erosion">erosion</a>, 
    
    <a class="post-tag" href="https://zsylvester.github.io/tags/geomorphology">geomorphology</a>, 
    
    <a class="post-tag" href="https://zsylvester.github.io/tags/jupyter">jupyter</a>
    
  </span>
  
  
</div>

      <div class="post-body" itemprop="articleBody">
        <p>Ever since I became interested in science, I started to have a vague idea that calculus, matrix algebra, partial differential equations, and numerical methods are all fundamental to the physical sciences and engineering and they are linked in some way to each other. The emphasis here is on the word vague; I have to admit that I had no clear, detailed understanding of how these links actually work. It seems like my formal education both in math and physics stopped just short of where everything would have nicely come together. Papers that are really important in geomorphology, sedimentology or stratigraphy seemed impossible to read as soon as they started assuming that I knew quite a bit about convective acceleration, numerical schemes, boundary conditions, and Cholesky factorization. Because I didn’t.</p>
<p>So I have decided a few months ago that I had to do something about this. This blog post documents the initial – and admittedly difficult – steps of my learning; the purpose is to go through the process of discretizing a partial differential equation, setting up a numerical scheme, and solving the resulting system of equations in Python and IPython notebook. I am learning this as I am doing it, so it may seem pedestrian and slow-moving to a lot of people but I am sure there are others who will find it useful. Most of what follows, except the Python code and the bit on fault scarps, is based on and inspired by Slingerland and Kump (2011): <a href="http://www.amazon.com/dp/0691145148/ref=cm_sw_r_tw_dp_iG3Wub0YJKYJK">Mathematical Modeling of Earth’s Dynamical Systems</a> (strongly recommended). You can view and download the <a href="https://github.com/zsylvester/notebooks/blob/master/diffusion_equation.ipynb">IPython Notebook version of this post</a> from Github.</p>
<h2 id="estimating-the-derivatives-in-the-diffusion-equation-using-the-taylor-expansion">Estimating the derivatives in the diffusion equation using the Taylor expansion</h2>
<p>This is the one-dimensional diffusion equation:</p>
<p>$$\frac{\partial T}{\partial t} - D\frac{\partial^2 T}{\partial x^2} = 0$$</p>
<p>The Taylor expansion of value of a function u at a point $\Delta x$  ahead of the point x where the function is known can be written as:</p>
<p>$$ u(x+\Delta x) = u(x) + \Delta x \frac{\partial u}{\partial x} + \frac{\Delta x^2}{2} \frac{\partial^2 u}{\partial x^2} + \frac{\Delta x^3}{6} \frac{\partial^3 u}{\partial x^3} + O(\Delta x^4) $$</p>
<p>Taylor expansion of value of the function $u$ at a point one space step behind:</p>
<p>$$ u(x-\Delta x) = u(x) - \Delta x \frac{\partial u}{\partial x} + \frac{\Delta x^2}{2} \frac{\partial^2 u}{\partial x^2} - \frac{\Delta x^3}{6} \frac{\partial^3 u}{\partial x^3} + O(\Delta x^4) $$</p>
<p>Solving the first Taylor expansion above for $\frac{\partial u}{\partial x}$ and dropping all higher-order terms yields the forward difference operator:</p>
<p>$$ \frac{\partial u}{\partial x} = \frac{u(x+\Delta x)-u(x)}{\Delta x} + O(\Delta x) $$</p>
<p>Similarly, the second equation yields the backward difference operator:</p>
<p>$$ \frac{\partial u}{\partial x} = \frac{u(x)-u(x-\Delta x)}{\Delta x} + O(\Delta x) $$</p>
<p>Subtracting the second equation from the first one gives the centered difference operator:</p>
<p>$$ \frac{\partial u}{\partial x} = \frac{u(x+\Delta x)-u(x-\Delta x)}{2\Delta x} + O(\Delta x^2) $$</p>
<p>The centered difference operator is more accurate than the other two.</p>
<p>Finally, if the two Taylor expansions are added, we get an estimate of the second order partial derivative:</p>
<p>$$ \frac{\partial^2 u}{\partial x^2} = \frac{u(x+\Delta x)-2u(x)+u(x-\Delta x)}{\Delta x^2} + O(\Delta x^2) $$</p>
<p>Next we use the forward difference operator to estimate the first term in the diffusion equation:</p>
<p>$$ \frac{\partial T}{\partial t} = \frac{T(t+\Delta t)-T(t)}{\Delta t} $$</p>
<p>The second term is expressed using the estimation of the second order partial derivative:</p>
<p>$$ \frac{\partial^2 T}{\partial x^2} = \frac{T(x+\Delta x)-2T(x)+T(x-\Delta x)}{\Delta x^2} $$</p>
<p>Now the diffusion equation can be written as</p>
<p>$$ \frac{T(t+\Delta t)-T(t)}{\Delta t} - D \frac{T(x+\Delta x)-2T(x)+T(x-\Delta x)}{\Delta x^2} = 0 $$</p>
<p>This is equivalent to</p>
<p>$$ T(t+\Delta t) - T(t) - \frac{D\Delta t}{\Delta x^2}(T(x+\Delta x)-2T(x)+T(x-\Delta x)) = 0 $$</p>
<p>The expression $ D\frac{\Delta t}{\Delta x^2} $ is called the diffusion number, denoted here with $s$:</p>
<p>$$ s = D\frac{\Delta t}{\Delta x^2} $$</p>
<h2 id="ftcs-explicit-scheme-and-analytic-solution">FTCS explicit scheme and analytic solution</h2>
<p>If we use $n$ to refer to indices in time and $j$ to refer to indices in space, the above equation can be written as</p>
<p>$$ T[n+1,j] = T[n,j] + s(T[n,j+1]-2T[n,j]+T[n,j-1]) $$</p>
<p>This is called a forward-in-time, centered-in-space (FTCS) scheme. Its &lsquo;footprint&rsquo; looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span>matplotlib inline
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span>config InlineBackend<span style="color:#f92672">.</span>figure_format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;svg&#39;</span> <span style="color:#75715e"># display plots in SVG format</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>],[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>],<span style="color:#e6db74">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>],[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],<span style="color:#e6db74">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>],[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],<span style="color:#e6db74">&#39;ko&#39;</span>,markersize<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1.1</span>,<span style="color:#ae81ff">0.1</span>,<span style="color:#e6db74">&#39;T[n,j]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">0.1</span>,<span style="color:#ae81ff">0.1</span>,<span style="color:#e6db74">&#39;T[n,j-1]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1.1</span>,<span style="color:#ae81ff">1.1</span>,<span style="color:#e6db74">&#39;T[n+1,j]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">2.1</span>,<span style="color:#ae81ff">0.1</span>,<span style="color:#e6db74">&#39;T[n,j+1]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;space&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;time&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;equal&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>yticks([<span style="color:#ae81ff">0.0</span>,<span style="color:#ae81ff">1.0</span>],[])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xticks([<span style="color:#ae81ff">0.0</span>,<span style="color:#ae81ff">1.0</span>],[])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;FTCS explicit scheme&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>,<span style="color:#ae81ff">2.5</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>,<span style="color:#ae81ff">1.5</span>]);
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/diffusion_fig_1.png#center600" alt="drawing"></p>
<p>Now we are ready to write the code that is the solution for exercise 2 in Chapter 2 of Slingerland and Kump (2011). This is an example where the one-dimensional diffusion equation is applied to viscous flow of a Newtonian fluid adjacent to a solid wall. If the wall starts moving with a velocity of 10 m/s, and the flow is assumed to be laminar, the velocity profile of the fluid is described by the equation</p>
<p>$$ \frac{\partial V}{\partial t} - \nu \frac{\partial^2 V}{\partial y^2} = 0 $$</p>
<p>where $\nu$ is the kinematic viscosity of the fluid. We want to figure out how the velocity will change through time as a function of distance from the wall. [Note that I have changed the original 40 m/s to 10 m/s &ndash; the former seems like an unnaturally large velocity to me].</p>
<p>We can compare the numerical results with the analytic solution, which is known for this problem:</p>
<p>$$ V = V_0 \Big( \sum\limits_0^\infty erfc(2n\eta_1+\eta) - \sum\limits_0^\infty erfc(2(n+1)\eta_1+\eta) \Big)  $$</p>
<p>where</p>
<p>$$ \eta_1 = \frac{h}{2\sqrt{\nu t}} $$</p>
<p>and</p>
<p>$$ \eta = \frac{y}{2\sqrt{\nu t}} $$</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>dt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0005</span> <span style="color:#75715e"># grid size for time (s)</span>
</span></span><span style="display:flex;"><span>dy <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0005</span> <span style="color:#75715e"># grid size for space (m)</span>
</span></span><span style="display:flex;"><span>viscosity <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">10</span><span style="color:#f92672">**</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>) <span style="color:#75715e"># kinematic viscosity of oil (m2/s)</span>
</span></span><span style="display:flex;"><span>y_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.04</span> <span style="color:#75715e"># in m</span>
</span></span><span style="display:flex;"><span>t_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e"># total time in s</span>
</span></span><span style="display:flex;"><span>V0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#75715e"># velocity in m/s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># function to calculate velocity profiles based on a finite difference approximation to the 1D diffusion equation and the </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># FTCS (forward-in-time, centered-in-space) scheme:</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">diffusion_FTCS</span>(dt,dy,t_max,y_max,viscosity,V0):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># diffusion number (has to be less than 0.5 for the solution to be stable):</span>
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">=</span> viscosity<span style="color:#f92672">*</span>dt<span style="color:#f92672">/</span>dy<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> 
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,y_max<span style="color:#f92672">+</span>dy,dy) 
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,t_max<span style="color:#f92672">+</span>dt,dt)
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> len(t)
</span></span><span style="display:flex;"><span>    c <span style="color:#f92672">=</span> len(y)
</span></span><span style="display:flex;"><span>    V <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros([r,c])
</span></span><span style="display:flex;"><span>    V[:,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> V0
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,r<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>): <span style="color:#75715e"># time</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,c<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>): <span style="color:#75715e"># space</span>
</span></span><span style="display:flex;"><span>            V[n<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,j] <span style="color:#f92672">=</span> V[n,j] <span style="color:#f92672">+</span> s<span style="color:#f92672">*</span>(V[n,j<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>V[n,j] <span style="color:#f92672">+</span> V[n,j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]) 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y,V,r,s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># note that this can be written without the for-loop in space, but it is easier to read it this way</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> scipy.special <span style="color:#f92672">import</span> erfc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># function to calculate velocity profiles using the analytic solution:</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">diffusion_analytic</span>(t,h,V0,dy,viscosity):
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,h<span style="color:#f92672">+</span>dy,dy)
</span></span><span style="display:flex;"><span>    eta1 <span style="color:#f92672">=</span> h<span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>(t<span style="color:#f92672">*</span>viscosity)<span style="color:#f92672">**</span><span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    eta <span style="color:#f92672">=</span> y<span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>(t<span style="color:#f92672">*</span>viscosity)<span style="color:#f92672">**</span><span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    sum1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    sum2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1000</span>):
</span></span><span style="display:flex;"><span>        sum1 <span style="color:#f92672">=</span> sum1 <span style="color:#f92672">+</span> erfc(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>n<span style="color:#f92672">*</span>eta1<span style="color:#f92672">+</span>eta)
</span></span><span style="display:flex;"><span>        sum2 <span style="color:#f92672">=</span> sum2 <span style="color:#f92672">+</span> erfc(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>(n<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span>eta1<span style="color:#f92672">-</span>eta)
</span></span><span style="display:flex;"><span>    V_analytic <span style="color:#f92672">=</span> V0<span style="color:#f92672">*</span>(sum1<span style="color:#f92672">-</span>sum2)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> V_analytic
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y,V,r,s <span style="color:#f92672">=</span> diffusion_FTCS(dt,dy,t_max,y_max,viscosity,V0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># plotting:</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>plot_times <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0.2</span>,<span style="color:#ae81ff">1.0</span>,<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> plot_times:
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>plot(y,V[t<span style="color:#f92672">/</span>dt,:],<span style="color:#e6db74">&#39;Gray&#39;</span>,label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;numerical&#39;</span>)
</span></span><span style="display:flex;"><span>    V_analytic <span style="color:#f92672">=</span> diffusion_analytic(t,<span style="color:#ae81ff">0.04</span>,<span style="color:#ae81ff">10</span>,dy,viscosity)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>plot(y,V_analytic,<span style="color:#e6db74">&#39;ok&#39;</span>,label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;analytic&#39;</span>,markersize<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> t<span style="color:#f92672">==</span><span style="color:#ae81ff">0.2</span>:
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>legend(fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;distance from wall (m)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;velocity (m/s)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis([<span style="color:#ae81ff">0</span>,y_max,<span style="color:#ae81ff">0</span>,V0])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;comparison between explicit numerical </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">(FTCS scheme) and analytic solutions&#39;</span>);
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/diffusion_fig_2.png#center600" alt="drawing"></p>
<p>The dots (analytic solution) overlap pretty well with the lines (numerical solution). However, this would not be the case if we changed the discretization so that the diffusion number was larger. Let&rsquo;s look at the stability of the FTCS numerical scheme, by computing the solution with different diffusion numbers. It turns out that the diffusion number $s$ has to be less than 0.5 for the FTCS scheme to remain stable. What follows is a reproduction of Figure 2.7 in Slingerland and Kump (2011):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>dt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0005</span> <span style="color:#75715e"># grid size for time (m)</span>
</span></span><span style="display:flex;"><span>dy <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0005</span> <span style="color:#75715e"># grid size for space (s)</span>
</span></span><span style="display:flex;"><span>y,V,r,s <span style="color:#f92672">=</span> diffusion_FTCS(dt,dy,t_max,y_max,viscosity,V0)
</span></span><span style="display:flex;"><span>V_analytic <span style="color:#f92672">=</span> diffusion_analytic(<span style="color:#ae81ff">0.5</span>,<span style="color:#ae81ff">0.04</span>,V0,dy,viscosity)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(y,V_analytic<span style="color:#f92672">-</span>V[int(<span style="color:#ae81ff">0.5</span><span style="color:#f92672">/</span>dt)],<span style="color:#e6db74">&#39;--k&#39;</span>,label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;small s&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dy <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0010</span>
</span></span><span style="display:flex;"><span>dt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.00254</span>
</span></span><span style="display:flex;"><span>y,V,r,s <span style="color:#f92672">=</span> diffusion_FTCS(dt,dy,t_max,y_max,viscosity,V0)
</span></span><span style="display:flex;"><span>V_analytic <span style="color:#f92672">=</span> diffusion_analytic(<span style="color:#ae81ff">0.5</span>,<span style="color:#ae81ff">0.04</span>,V0,dy,viscosity)
</span></span><span style="display:flex;"><span>V_numeric <span style="color:#f92672">=</span> V[int(r<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>),:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(y,V_analytic<span style="color:#f92672">-</span>V_numeric,<span style="color:#e6db74">&#39;k&#39;</span>,label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;large s&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;distance from wall (m)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;velocity difference (m/s)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;difference between numerical and analytic </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> solutions for different </span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">s</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74"> values&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis([<span style="color:#ae81ff">0</span>,y_max,<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>legend();
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/diffusion_fig_3.png#center600" alt="drawing"></p>
<h2 id="laasonen-implicit-scheme">Laasonen implicit scheme</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>],[<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>],<span style="color:#e6db74">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>],[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],<span style="color:#e6db74">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>],[<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>],<span style="color:#e6db74">&#39;ko&#39;</span>,markersize<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1.1</span>,<span style="color:#ae81ff">0.1</span>,<span style="color:#e6db74">&#39;T[n,j]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">0.1</span>,<span style="color:#ae81ff">1.1</span>,<span style="color:#e6db74">&#39;T[n+1,j-1]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1.1</span>,<span style="color:#ae81ff">1.1</span>,<span style="color:#e6db74">&#39;T[n+1,j]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">2.1</span>,<span style="color:#ae81ff">1.1</span>,<span style="color:#e6db74">&#39;T[n+1,j+1]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;space&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;time&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;equal&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>yticks([<span style="color:#ae81ff">0.0</span>,<span style="color:#ae81ff">1.0</span>],[])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xticks([<span style="color:#ae81ff">0.0</span>,<span style="color:#ae81ff">1.0</span>],[])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Laasonen scheme&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>,<span style="color:#ae81ff">2.5</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>,<span style="color:#ae81ff">1.5</span>]);
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/diffusion_fig_4.png#center600" alt="drawing"></p>
<p>Instead of estimating the velocity at time step $n+1$ with the curvature calculated at time step $n$, as it is done in the FTCS explicit scheme, we can also estimate the curvature at time step $n+1$, using the velocity change from time step $n$ to time step $n+1$:</p>
<p>$$ s\big(T(x+\Delta x)-2T(x)+T(x-\Delta x)\big) = T(t+\Delta t)-T(t) $$</p>
<p>Written in matrix notation, this is equiavlent to</p>
<p>$$ s\big(T[n+1,j+1]-2T[n+1,j]+T[n+1,j-1]\big) = T[n+1,j]-T[n,j] $$</p>
<p>After some reshuffling we get</p>
<p>$$ -sT[n+1,j+1] + (1+2s)T[n+1,j] - sT[n+1,j-1] = T[n,j] $$</p>
<p>This is the Laasonen fully implicit scheme. Unlike the FTCS scheme, the Laasonen scheme is unconditionally stable. Let&rsquo;s try to write some Python code that implements this scheme. First it is useful for me to go through the logic of constructing the system of equations that needs to be solved. Let&rsquo;s consider a grid that only consists of 5 nodes in space and we are going to estimate the values of $T$ at the locations marked by the red dots in the figure below. Black dots mark the locations where we already know the values of $T$ (from the initial and boundary conditions).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">0</span>],[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>],<span style="color:#e6db74">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">4</span>):
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>plot([i,i],[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],<span style="color:#e6db74">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">4</span>],[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>],<span style="color:#e6db74">&#39;ko&#39;</span>,markersize<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>],[<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>],<span style="color:#e6db74">&#39;ro&#39;</span>,markersize<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>text(i<span style="color:#f92672">+</span><span style="color:#ae81ff">0.1</span>,<span style="color:#ae81ff">0.1</span>,<span style="color:#e6db74">&#39;T[0,&#39;</span><span style="color:#f92672">+</span>str(i)<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;]&#39;</span>)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>text(i<span style="color:#f92672">+</span><span style="color:#ae81ff">0.1</span>,<span style="color:#ae81ff">1.1</span>,<span style="color:#e6db74">&#39;T[1,&#39;</span><span style="color:#f92672">+</span>str(i)<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;space&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;time&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;equal&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>yticks([<span style="color:#ae81ff">0.0</span>,<span style="color:#ae81ff">1.0</span>],[<span style="color:#e6db74">&#39;0&#39;</span>,<span style="color:#e6db74">&#39;1&#39;</span>])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;first two time steps on a 1D grid of five points&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>,<span style="color:#ae81ff">4.8</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>,<span style="color:#ae81ff">1.5</span>]);
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/diffusion_fig_5.png#center600" alt="drawing"></p>
<p>First we write the equations using the Laasonen scheme centered on the three points of unknown velocity (or temperature) &ndash; these are the red dots in the figure above:</p>
<p><img src="https://zsylvester.github.io/img/diffusion_fig_6.png#center800" alt="drawing"></p>
<p>It may seem like we have five unknowns and only three equations but $T[1,0]$ and $T[1,4]$ are on the boundaries and they are known. Let&rsquo;s rearrange the equation system so that the left hand side has ony the unknowns:</p>
<p><img src="https://zsylvester.github.io/img/diffusion_fig_7.png#center700" alt="drawing"></p>
<p>In matrix form this is equivalent to</p>
<p><img src="https://zsylvester.github.io/img/diffusion_fig_8.png#center600" alt="drawing"></p>
<p>This of course can be extended to larger dimensions than shown here.
Now we are ready to write the code for the Laasonen scheme. One important difference relative to what I did in the explicit scheme example is that in this case we only keep the last two versions of the velocity distribution in memory, as opposed to preallocating the full array of $nt \times ny$ size as we did before. This difference is not a significant time saver for simple problems like this but once you start dealing with more complicated tasks and code it is not possible and/or practical to keep the results of all time steps in memory.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">from</span> scipy.sparse <span style="color:#f92672">import</span> diags
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">diffusion_Laasonen</span>(dt,dy,t_max,y_max,viscosity,V0,V1):
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">=</span> viscosity<span style="color:#f92672">*</span>dt<span style="color:#f92672">/</span>dy<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>  <span style="color:#75715e"># diffusion number</span>
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,y_max<span style="color:#f92672">+</span>dy,dy) 
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,t_max<span style="color:#f92672">+</span>dt,dt)
</span></span><span style="display:flex;"><span>    nt <span style="color:#f92672">=</span> len(t) <span style="color:#75715e"># number of time steps</span>
</span></span><span style="display:flex;"><span>    ny <span style="color:#f92672">=</span> len(y) <span style="color:#75715e"># number of dy steps</span>
</span></span><span style="display:flex;"><span>    V <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((ny,)) <span style="color:#75715e"># initial condition</span>
</span></span><span style="display:flex;"><span>    V[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> V0 <span style="color:#75715e"># boundary condition on left side</span>
</span></span><span style="display:flex;"><span>    V[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> V1 <span style="color:#75715e"># boundary condition on right side</span>
</span></span><span style="display:flex;"><span>    A <span style="color:#f92672">=</span> diags([<span style="color:#f92672">-</span>s, <span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>s, <span style="color:#f92672">-</span>s], [<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>], shape<span style="color:#f92672">=</span>(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>))<span style="color:#f92672">.</span>toarray() <span style="color:#75715e"># create coefficient matrix</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(nt): <span style="color:#75715e"># time is going from second time step to last</span>
</span></span><span style="display:flex;"><span>        Vn <span style="color:#f92672">=</span> V <span style="color:#75715e">#.copy()</span>
</span></span><span style="display:flex;"><span>        B <span style="color:#f92672">=</span> Vn[<span style="color:#ae81ff">1</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#75715e"># create matrix of knowns on the RHS of the equation</span>
</span></span><span style="display:flex;"><span>        B[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> B[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">+</span>s<span style="color:#f92672">*</span>V0
</span></span><span style="display:flex;"><span>        B[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> B[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">+</span>s<span style="color:#f92672">*</span>V1
</span></span><span style="display:flex;"><span>        V[<span style="color:#ae81ff">1</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linalg<span style="color:#f92672">.</span>solve(A,B) <span style="color:#75715e"># solve the equation using numpy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y,t,V,s
</span></span></code></pre></div><p>Because this is a stable scheme, it is possible to get reasonable solutions with relatively large time steps (which was not possible with the FTCS scheme):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>dt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span> <span style="color:#75715e"># grid size for time (s)</span>
</span></span><span style="display:flex;"><span>dy <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0005</span> <span style="color:#75715e"># grid size for space (m)</span>
</span></span><span style="display:flex;"><span>viscosity <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">10</span><span style="color:#f92672">**</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>) <span style="color:#75715e"># kinematic viscosity of oil (m2/s)</span>
</span></span><span style="display:flex;"><span>y_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.04</span> <span style="color:#75715e"># in m</span>
</span></span><span style="display:flex;"><span>V0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">10.0</span> <span style="color:#75715e"># velocity in m/s</span>
</span></span><span style="display:flex;"><span>V1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span> <span style="color:#75715e"># velocity in m/s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> time <span style="color:#f92672">in</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1.0</span>,<span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>    y,t,V,s <span style="color:#f92672">=</span> diffusion_Laasonen(dt,dy,time,y_max,viscosity,V0,V1)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>plot(y,V,<span style="color:#e6db74">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;distance from wall (m)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;velocity (m/s)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis([<span style="color:#ae81ff">0</span>,y_max,<span style="color:#ae81ff">0</span>,V0])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Laasonen implicit scheme&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>);
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/diffusion_fig_9.png#center600" alt="drawing"></p>
<p>Just for fun, let&rsquo;s see what happens if we set in motion the right side of the domain as well; that is, set $V_1$ to a non-zero value:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>dt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span> <span style="color:#75715e"># grid size for time (s)</span>
</span></span><span style="display:flex;"><span>dy <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0005</span> <span style="color:#75715e"># grid size for space (m)</span>
</span></span><span style="display:flex;"><span>viscosity <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">10</span><span style="color:#f92672">**</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>) <span style="color:#75715e"># kinematic viscosity of oil (m2/s)</span>
</span></span><span style="display:flex;"><span>y_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.04</span> <span style="color:#75715e"># in m</span>
</span></span><span style="display:flex;"><span>V0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">10.0</span> <span style="color:#75715e"># velocity in m/s</span>
</span></span><span style="display:flex;"><span>V1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">5.0</span> <span style="color:#75715e"># velocity in m/s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> time <span style="color:#f92672">in</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1.0</span>,<span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>    y,t,V,s <span style="color:#f92672">=</span> diffusion_Laasonen(dt,dy,time,y_max,viscosity,V0,V1)
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>plot(y,V,<span style="color:#e6db74">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;distance from wall (m)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;velocity (m/s)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis([<span style="color:#ae81ff">0</span>,y_max,<span style="color:#ae81ff">0</span>,V0])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Laasonen implicit scheme&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>);
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/diffusion_fig_10.png#center600" alt="drawing"></p>
<h2 id="crank-nicolson-scheme">Crank-Nicolson scheme</h2>
<p>The Crank-Nicholson scheme is based on the idea that the forward-in-time approximation of the time derivative is estimating the derivative at the halfway point between times $n$ and $n+1$, therefore the curvature of space should be estimated there as well. The &lsquo;footprint&rsquo; of the scheme looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>],[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>],<span style="color:#e6db74">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>],[<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>],<span style="color:#e6db74">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>],[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],<span style="color:#e6db74">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot([<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>],[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>],<span style="color:#e6db74">&#39;ko&#39;</span>,markersize<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">0.1</span>,<span style="color:#ae81ff">0.1</span>,<span style="color:#e6db74">&#39;T[n,j-1]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1.1</span>,<span style="color:#ae81ff">0.1</span>,<span style="color:#e6db74">&#39;T[n,j]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">2.1</span>,<span style="color:#ae81ff">0.1</span>,<span style="color:#e6db74">&#39;T[n,j+1]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">0.1</span>,<span style="color:#ae81ff">1.1</span>,<span style="color:#e6db74">&#39;T[n+1,j-1]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1.1</span>,<span style="color:#ae81ff">1.1</span>,<span style="color:#e6db74">&#39;T[n+1,j]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">2.1</span>,<span style="color:#ae81ff">1.1</span>,<span style="color:#e6db74">&#39;T[n+1,j+1]&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;space&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;time&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;equal&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>yticks([<span style="color:#ae81ff">0.0</span>,<span style="color:#ae81ff">1.0</span>],[])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xticks([<span style="color:#ae81ff">0.0</span>,<span style="color:#ae81ff">1.0</span>],[])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Crank-Nicolson scheme&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>,<span style="color:#ae81ff">2.5</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>,<span style="color:#ae81ff">1.5</span>]);
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/diffusion_fig_11.png#center600" alt="drawing"></p>
<p>The curvature at the halfway point can be estimated through averaging the curvatures that are calculated at $n$ and $n+1$:</p>
<p>$$ 0.5s\big(T[n+1,j+1]-2T[n+1,j]+T[n+1,j-1]\big) + 0.5s\big(T[n,j+1]-2T[n,j]+T[n,j-1]\big) = T[n+1,j]-T[n,j] $$</p>
<p>This can be rearranged so that terms at $n+1$ are on the left hand side:</p>
<p>$$ -0.5sT[n+1,j-1]+(1+s)T[n+1,j]-0.5sT[n+1,j+1] = 0.5sT[n,j-1]+(1-s)T[n,j]+0.5sT[n,j+1] $$</p>
<p>Just like we did for the Laasonen scheme, we can write the equations for the first two time steps:</p>
<p><img src="https://zsylvester.github.io/img/array_1.png#center700" alt="drawing"></p>
<p>Writing this in matrix form, with all the unknowns on the LHS:</p>
<p><img src="https://zsylvester.github.io/img/array_2.png#center700" alt="drawing"></p>
<p>Now we can write the code for the Crank-Nicolson scheme. We will use a new input parameter called $ntout$ that determines how many time steps we want to write out to memory. This way you don&rsquo;t have to re-run the code if you want to plot multiple time steps.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">diffusion_Crank_Nicolson</span>(dy,ny,dt,nt,D,V,ntout):
</span></span><span style="display:flex;"><span>    Vout <span style="color:#f92672">=</span> [] <span style="color:#75715e"># list for storing V arrays at certain time steps</span>
</span></span><span style="display:flex;"><span>    V0 <span style="color:#f92672">=</span> V[<span style="color:#ae81ff">0</span>] <span style="color:#75715e"># boundary condition on left side</span>
</span></span><span style="display:flex;"><span>    V1 <span style="color:#f92672">=</span> V[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#75715e"># boundary condition on right side</span>
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">=</span> D<span style="color:#f92672">*</span>dt<span style="color:#f92672">/</span>dy<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>  <span style="color:#75715e"># diffusion number</span>
</span></span><span style="display:flex;"><span>    A <span style="color:#f92672">=</span> diags([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span><span style="color:#f92672">*</span>s, <span style="color:#ae81ff">1</span><span style="color:#f92672">+</span>s, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span><span style="color:#f92672">*</span>s], [<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>], shape<span style="color:#f92672">=</span>(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>))<span style="color:#f92672">.</span>toarray() <span style="color:#75715e"># create coefficient matrix</span>
</span></span><span style="display:flex;"><span>    B1 <span style="color:#f92672">=</span> diags([<span style="color:#ae81ff">0.5</span><span style="color:#f92672">*</span>s, <span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>s, <span style="color:#ae81ff">0.5</span><span style="color:#f92672">*</span>s],[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>], shape<span style="color:#f92672">=</span>(ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, ny<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>))<span style="color:#f92672">.</span>toarray()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,nt): <span style="color:#75715e"># time is going from second time step to last</span>
</span></span><span style="display:flex;"><span>        Vn <span style="color:#f92672">=</span> V
</span></span><span style="display:flex;"><span>        B <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>dot(Vn[<span style="color:#ae81ff">1</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],B1) 
</span></span><span style="display:flex;"><span>        B[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> B[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">+</span><span style="color:#ae81ff">0.5</span><span style="color:#f92672">*</span>s<span style="color:#f92672">*</span>(V0<span style="color:#f92672">+</span>V0)
</span></span><span style="display:flex;"><span>        B[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> B[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">+</span><span style="color:#ae81ff">0.5</span><span style="color:#f92672">*</span>s<span style="color:#f92672">*</span>(V1<span style="color:#f92672">+</span>V1)
</span></span><span style="display:flex;"><span>        V[<span style="color:#ae81ff">1</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linalg<span style="color:#f92672">.</span>solve(A,B)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> n <span style="color:#f92672">%</span> int(nt<span style="color:#f92672">/</span>float(ntout)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">or</span> n<span style="color:#f92672">==</span>nt<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            Vout<span style="color:#f92672">.</span>append(V<span style="color:#f92672">.</span>copy()) <span style="color:#75715e"># numpy arrays are mutable, so we need to write out a copy of V, not V itself</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Vout,s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.001</span> <span style="color:#75715e"># grid size for time (s)</span>
</span></span><span style="display:flex;"><span>dy <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.001</span> <span style="color:#75715e"># grid size for space (m)</span>
</span></span><span style="display:flex;"><span>viscosity <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">10</span><span style="color:#f92672">**</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>) <span style="color:#75715e"># kinematic viscosity of oil (m2/s)</span>
</span></span><span style="display:flex;"><span>y_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.04</span> <span style="color:#75715e"># in m</span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,y_max<span style="color:#f92672">+</span>dy,dy) 
</span></span><span style="display:flex;"><span>ny <span style="color:#f92672">=</span> len(y)
</span></span><span style="display:flex;"><span>nt <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>V <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((ny,)) <span style="color:#75715e"># initial condition</span>
</span></span><span style="display:flex;"><span>V[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>Vout,s <span style="color:#f92672">=</span> diffusion_Crank_Nicolson(dy,ny,dt,nt,viscosity,V,<span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> V <span style="color:#f92672">in</span> Vout:
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>plot(y,V,<span style="color:#e6db74">&#39;k&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;distance from wall (m)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;velocity (m/s)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis([<span style="color:#ae81ff">0</span>,y_max,<span style="color:#ae81ff">0</span>,V[<span style="color:#ae81ff">0</span>]])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Crank-Nicolson scheme&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>);
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/diffusion_fig_12.png#center600" alt="drawing"></p>
<h2 id="fault-scarp-diffusion">Fault scarp diffusion</h2>
<p>So far we have been using a somewhat artificial (but simple) example to explore numerical methods that can be used to solve the diffusion equation. Next we look at a geomorphologic application: the evolution of a fault scarp through time. Although the idea that convex hillslopes are the result of diffusive processes go back to G. K. Gilbert, it was Culling (1960, in the paper <a href="http://www.jstor.org/stable/30059222">Analytical Theory of Erosion</a>) who first applied the mathematics of the heat equation - that was already well known to physicists at that time - to geomorphology.</p>
<p>Here I used the Crank-Nicolson scheme to model a fault scarp with a vertical offset of 10 m. To compare the numerical results with the analytical solution (which comes from Culling, 1960), I created a function that was written using a Python package for symbolic math called <a href="http://sympy.org">sympy</a>. One of the advantages of sympy is that you can quickly display equations in $\LaTeX$.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">import</span> sympy
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sympy <span style="color:#f92672">import</span> init_printing
</span></span><span style="display:flex;"><span>init_printing(use_latex<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>x, t, Y1, a, K <span style="color:#f92672">=</span> sympy<span style="color:#f92672">.</span>symbols(<span style="color:#e6db74">&#39;x t Y1 a K&#39;</span>)
</span></span><span style="display:flex;"><span>Y <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span>)<span style="color:#f92672">*</span>Y1<span style="color:#f92672">*</span>(sympy<span style="color:#f92672">.</span>erf((a<span style="color:#f92672">-</span>x)<span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>sympy<span style="color:#f92672">.</span>sqrt(K<span style="color:#f92672">*</span>t))) <span style="color:#f92672">+</span> sympy<span style="color:#f92672">.</span>erf((a<span style="color:#f92672">+</span>x)<span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>sympy<span style="color:#f92672">.</span>sqrt(K<span style="color:#f92672">*</span>t))))
</span></span><span style="display:flex;"><span>Y
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/eq_1.png#center400" alt="drawing"></p>
<p>The variables in this equation are $x$ - horizontal coordinates, $t$ - time, $a$ - value of $x$ where fault is located, $K$ - diffusion coefficient, $Y_1$ - height of fault scarp.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sympy.utilities.lambdify <span style="color:#f92672">import</span> lambdify
</span></span><span style="display:flex;"><span>f <span style="color:#f92672">=</span> lambdify((x, t, Y1, a, K), Y, modules<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;numpy&#39;</span>, <span style="color:#e6db74">&#39;sympy&#39;</span>]) <span style="color:#75715e"># function for analytic solution</span>
</span></span><span style="display:flex;"><span>dt <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.5</span> <span style="color:#75715e"># time step (years)</span>
</span></span><span style="display:flex;"><span>dy <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span> <span style="color:#75715e"># grid size for space (m)</span>
</span></span><span style="display:flex;"><span>D <span style="color:#f92672">=</span> <span style="color:#ae81ff">50E-4</span> <span style="color:#75715e"># diffusion coefficient in m2/yr - e.g., Fernandes and Dietrich, 1997</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#75715e"># height of fault scarp in m</span>
</span></span><span style="display:flex;"><span>y_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span> <span style="color:#75715e"># length of domain in m</span>
</span></span><span style="display:flex;"><span>t_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span> <span style="color:#75715e"># total time in years</span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,y_max<span style="color:#f92672">+</span>dy,dy) 
</span></span><span style="display:flex;"><span>ny <span style="color:#f92672">=</span> len(y)
</span></span><span style="display:flex;"><span>nt <span style="color:#f92672">=</span> int(t_max<span style="color:#f92672">/</span>dt)
</span></span><span style="display:flex;"><span>V <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((ny,)) <span style="color:#75715e"># initial condition</span>
</span></span><span style="display:flex;"><span>V[:round(ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span>)] <span style="color:#f92672">=</span> h <span style="color:#75715e"># initial condition</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Vout,s <span style="color:#f92672">=</span> diffusion_Crank_Nicolson(dy,ny,dt,nt,D,V,<span style="color:#ae81ff">20</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">5.2</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> V <span style="color:#f92672">in</span> Vout:
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>plot(y,V,<span style="color:#e6db74">&#39;gray&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;distance (m)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;height (m)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis([<span style="color:#ae81ff">0</span>,y_max,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">10</span>])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;fault scarp diffusion&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>);
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(y,np<span style="color:#f92672">.</span>asarray([f(x0, t_max, h, y_max<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span>, D) <span style="color:#66d9ef">for</span> x0 <span style="color:#f92672">in</span> y]),<span style="color:#e6db74">&#39;r--&#39;</span>,linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>);
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/diffusion_fig_13.png#center800" alt="drawing"></p>
<p>The numerical and analytic solutions (dashed red line) are very similar in this case (total time = 500 years). Let&rsquo;s see what happens if we let the fault scarp evolve for a longer time.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>dt <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.5</span> <span style="color:#75715e"># time step (years)</span>
</span></span><span style="display:flex;"><span>dy <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span> <span style="color:#75715e"># grid size for space (m)</span>
</span></span><span style="display:flex;"><span>D <span style="color:#f92672">=</span> <span style="color:#ae81ff">50E-4</span> <span style="color:#75715e"># diffusion coefficient in m2/yr - e.g., Fernandes and Dietrich, 1997</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#75715e"># height of fault scarp in m</span>
</span></span><span style="display:flex;"><span>y_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span> <span style="color:#75715e"># length of domain in m</span>
</span></span><span style="display:flex;"><span>t_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">5000</span> <span style="color:#75715e"># total time in years</span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,y_max<span style="color:#f92672">+</span>dy,dy) 
</span></span><span style="display:flex;"><span>ny <span style="color:#f92672">=</span> len(y)
</span></span><span style="display:flex;"><span>nt <span style="color:#f92672">=</span> int(t_max<span style="color:#f92672">/</span>dt)
</span></span><span style="display:flex;"><span>V <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((ny,)) <span style="color:#75715e"># initial condition</span>
</span></span><span style="display:flex;"><span>V[:round(ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span>)] <span style="color:#f92672">=</span> h <span style="color:#75715e"># initial condition</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Vout,s <span style="color:#f92672">=</span> diffusion_Crank_Nicolson(dy,ny,dt,nt,D,V,<span style="color:#ae81ff">20</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">5.2</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> V <span style="color:#f92672">in</span> Vout:
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>plot(y,V,<span style="color:#e6db74">&#39;gray&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;distance (m)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;height (m)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis([<span style="color:#ae81ff">0</span>,y_max,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">10</span>])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;fault scarp diffusion&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>);
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(y,np<span style="color:#f92672">.</span>asarray([f(x0, t_max, h, y_max<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span>, D) <span style="color:#66d9ef">for</span> x0 <span style="color:#f92672">in</span> y]),<span style="color:#e6db74">&#39;r--&#39;</span>,linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>);
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/diffusion_fig_14.png#center800" alt="drawing"></p>
<p>This doesn&rsquo;t look very good, does it? The reason for the significant mismatch between the numerical and analytic solutions is the fixed nature of the boundary conditions: we keep the elevation at 10 m on the left side and at 0 m on the right side of the domain. There are two ways of getting a correct numerical solution: we either impose boundary conditions that approximate what the system is supposed to do if the elevations were not fixed; or we extend the space domain so that the boundary conditions can be kept fixed throughout the time of interest. Let&rsquo;s do the latter; all the other parameters are the same as above.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>dt <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.5</span> <span style="color:#75715e"># time step (years)</span>
</span></span><span style="display:flex;"><span>dy <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span> <span style="color:#75715e"># grid size for space (m)</span>
</span></span><span style="display:flex;"><span>D <span style="color:#f92672">=</span> <span style="color:#ae81ff">50E-4</span> <span style="color:#75715e"># diffusion coefficient in m2/yr - e.g., Fernandes and Dietrich, 1997</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#75715e"># height of fault scarp in m</span>
</span></span><span style="display:flex;"><span>y_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span> <span style="color:#75715e"># length of domain in m</span>
</span></span><span style="display:flex;"><span>t_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">5000</span> <span style="color:#75715e"># total time in years</span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,y_max<span style="color:#f92672">+</span>dy,dy) 
</span></span><span style="display:flex;"><span>ny <span style="color:#f92672">=</span> len(y)
</span></span><span style="display:flex;"><span>nt <span style="color:#f92672">=</span> int(t_max<span style="color:#f92672">/</span>dt)
</span></span><span style="display:flex;"><span>V <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((ny,)) <span style="color:#75715e"># initial condition</span>
</span></span><span style="display:flex;"><span>V[:round(ny<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span>)] <span style="color:#f92672">=</span> h <span style="color:#75715e"># initial condition</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Vout,s <span style="color:#f92672">=</span> diffusion_Crank_Nicolson(dy,ny,dt,nt,D,V,<span style="color:#ae81ff">20</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">5.2</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> V <span style="color:#f92672">in</span> Vout:
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>plot(y,V,<span style="color:#e6db74">&#39;gray&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;distance (m)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;height (m)&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>axis([<span style="color:#ae81ff">0</span>,y_max,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">10</span>])
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;fault scarp diffusion&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>);
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(y,np<span style="color:#f92672">.</span>asarray([f(x0, t_max, h, y_max<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span>, D) <span style="color:#66d9ef">for</span> x0 <span style="color:#f92672">in</span> y]),<span style="color:#e6db74">&#39;r--&#39;</span>,linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>);
</span></span></code></pre></div><p><img src="https://zsylvester.github.io/img/diffusion_fig_15.png#center800" alt="drawing"></p>
<p>Now we have a much better result. The vertical dashed lines show the extent of the domain in the previous experiment. We have also gained some insight into choosing boundary conditions and setting up the model domain. It is not uncommon that setting up the initial and boundary conditions is the most time-consuming and difficult part of running a numerical model.</p>
<h2 id="further-reading">Further reading</h2>
<p>R. Slingerland and L. Kump (2011) <a href="http://www.amazon.com/dp/0691145148/ref=cm_sw_r_tw_dp_iG3Wub0YJKYJK">Mathematical Modeling of Earth&rsquo;s Dynamical Systems</a></p>
<p>W. E. H. Culling (1960) <a href="http://www.jstor.org/stable/30059222">Analytical Theory of Erosion</a></p>
<p>L. Barba (2013) <a href="https://github.com/barbagroup/CFDPython">12 steps to Navier-Stokes</a> - an excellent introduction to computational fluid dynamics that uses IPython notebooks</p>
<p>I have blogged before about the geosciency aspects of the diffusion equation over <a href="http://hinderedsettling.com/2009/11/26/hillslope-diffusion/">here</a>.</p>

      </div>

      <meta itemprop="wordCount" content="3207">
      <meta itemprop="datePublished" content="2015-02-06">
      <meta itemprop="url" content="https://zsylvester.github.io/post/diffusion_equation/">
    </article>

    <ul class="pagination" role="navigation" aria-label="Pagination">
      
      <li class="arrow" aria-disabled="true"><a href="https://zsylvester.github.io/post/rivers_through_time/">&laquo; <em>Previous<span class="show-for-sr"> page</span></em>: Rivers through time, as seen in Landsat images</a></li>
      
      
      <li class="arrow" aria-disabled="true"><a href="https://zsylvester.github.io/post/decompaction/"><em>Next<span class="show-for-sr"> page</span></em>: Exploring (de)compaction with Python&nbsp;&raquo;</a></li>
      
    </ul>

    
  </div>
</div>

    </main>
    
<footer>
  <hr>
  <div class="row">
   <div class="column small-10 small-centered text-center">
     <em>Do you have a comment? Follow me at <a href="http://twitter.com/zzsylvester">@zzsylvester</a> on <span class="nowrap"><i class="fa fa-twitter-square"></i> Twitter</span>!</em>
    </div>
  </div>
</footer>


    <div class="endofpage">
      created with <a href="https://themes.gohugo.io/hugo-finite/">'Hugo finite' theme</a> by M. Brinkmann
    </div>

    <script src="https://zsylvester.github.io/js/jquery.js"></script>
    <script src="https://zsylvester.github.io/js/what-input.js"></script>
    <script src="https://zsylvester.github.io/js/foundation.min.js"></script>
    <script src="https://zsylvester.github.io/js/finite.js"></script>

    
    <script src="https://zsylvester.github.io/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    <script async src="https://zsylvester.github.io/js/MathJax/MathJax.js?config=TeX-AMS_CHTML"></script>
    
    
  </body>
</html>
